name: Release Extension

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

defaults:
  run:
    shell: bash

jobs:
  validate-version:
    name: Validate Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      duckdb_version: ${{ steps.get_duckdb_version.outputs.duckdb_version }}
      is_prerelease: ${{ steps.get_version.outputs.is_prerelease }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true

      - name: Get DuckDB Version
        id: get_duckdb_version
        shell: bash
        run: |
          cd duckdb
          # Get the exact tag from the submodule
          DUCKDB_VERSION=$(git describe --tags --abbrev=0)
          echo "duckdb_version=$DUCKDB_VERSION" >> $GITHUB_OUTPUT
          echo "Detected DuckDB version: $DUCKDB_VERSION"

      - name: Get Version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${{ github.ref_name }}"
          fi
          
          # Verify format (vX.Y.Z or vX.Y.Z-suffix)
          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "Error: Invalid version format '$VERSION'. Must start with 'v' followed by semver (e.g. v1.0.0)."
            exit 1
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          # Check if prerelease
          if [[ "$VERSION" == *"-"* ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          fi

  build-matrix:
    name: Build ${{ matrix.platform }} ${{ matrix.arch }}
    needs: validate-version
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            arch: x86_64
            platform: linux
            setup_script: scripts/setup_oci_linux.sh
          - os: ubuntu-24.04-arm
            arch: aarch64
            platform: linux
            setup_script: scripts/setup_oci_linux.sh
          - os: macos-14
            arch: arm64
            platform: macos
            setup_script: scripts/setup_oci_macos.sh
          - os: windows-2022
            arch: x86_64
            platform: windows
            setup_script: scripts/setup_oci_windows.ps1

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true

      - name: Install Dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libaio1t64 unzip ninja-build || sudo apt-get install -y libaio1 unzip ninja-build

      - name: Install Dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install ninja

      - name: Install Dependencies (Windows)
        if: runner.os == 'Windows'
        run: |
          choco install ninja

      - name: Install Oracle Instant Client
        shell: bash
        run: |
          if [ "${{ runner.os }}" == "Windows" ]; then
            pwsh -ExecutionPolicy Bypass -File ${{ matrix.setup_script }}
          else
            ./${{ matrix.setup_script }}
          fi

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install CMake
        if: runner.os != 'Windows'
        run: |
          # Check if cmake is installed, if not install it
          if ! command -v cmake &> /dev/null; then
             if [ "${{ runner.os }}" == "Linux" ]; then
                sudo apt-get install -y cmake
             elif [ "${{ runner.os }}" == "macOS" ]; then
                brew install cmake
             fi
          fi

      - name: Setup vcpkg (Windows)
        if: runner.os == 'Windows'
        uses: lukka/run-vcpkg@v11.1
        with:
          vcpkgGitCommitId: ce613c41372b23b1f51333815feb3edd87ef8a8b
          vcpkgGitURL: https://github.com/microsoft/vcpkg.git

      - name: Build Extension (Windows)
        if: runner.os == 'Windows'
        shell: cmd
        env:
          VCPKG_TOOLCHAIN_PATH: ${{ github.workspace }}\vcpkg\scripts\buildsystems\vcpkg.cmake
          VCPKG_TARGET_TRIPLET: x64-windows
        run: |
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
          mv "C:\Program Files\Git\usr\bin\link.exe" "C:\Program Files\Git\usr\bin\link-git.exe"
          make release

      - name: Build Extension (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          make release

      - name: Run Smoke Tests
        shell: bash
        run: |
          # Verify extension loads and runs basic query
          ./build/release/duckdb -unsigned -c "LOAD 'build/release/extension/oracle/oracle.duckdb_extension'; SELECT oracle_query('dummy', 'SELECT 1');" 2>&1 | grep "ORA-" || echo "Smoke test passed (expected Oracle error)"
          
          # Verify version (if we had a version function, we would check it here)
          ./build/release/duckdb -unsigned -c "LOAD 'build/release/extension/oracle/oracle.duckdb_extension'; SELECT * FROM duckdb_extensions() WHERE extension_name='oracle';"

      - name: Prepare Artifacts
        shell: bash
        run: |
          DUCKDB_VERSION=${{ needs.validate-version.outputs.duckdb_version }}
          PLATFORM=${{ matrix.platform }}
          ARCH=${{ matrix.arch }}

          # Map to DuckDB platform strings
          if [ "$PLATFORM" == "linux" ] && [ "$ARCH" == "x86_64" ]; then
            DUCKDB_PLATFORM="linux_amd64"
          elif [ "$PLATFORM" == "linux" ] && [ "$ARCH" == "aarch64" ]; then
            DUCKDB_PLATFORM="linux_arm64"
          elif [ "$PLATFORM" == "macos" ] && [ "$ARCH" == "arm64" ]; then
            DUCKDB_PLATFORM="osx_arm64"
          elif [ "$PLATFORM" == "windows" ] && [ "$ARCH" == "x86_64" ]; then
            DUCKDB_PLATFORM="windows_amd64"
          else
            echo "Unknown platform/arch combination: $PLATFORM / $ARCH"
            exit 1
          fi

          # Create directory structure for custom repository (GitHub Pages)
          # v<duckdb_version>/<platform>/oracle.duckdb_extension.gz
          mkdir -p deploy/${DUCKDB_VERSION}/${DUCKDB_PLATFORM}

          # Compress extension for GitHub Pages deployment
          gzip -c build/release/extension/oracle/oracle.duckdb_extension > deploy/${DUCKDB_VERSION}/${DUCKDB_PLATFORM}/oracle.duckdb_extension.gz

          # Create release directory with platform-specific filename
          # This prevents overwrites when artifacts are merged
          mkdir -p deploy/release
          cp "build/release/extension/oracle/oracle.duckdb_extension" "deploy/release/oracle-${DUCKDB_PLATFORM}.duckdb_extension"

          # Generate checksum for this platform's artifact
          cd deploy/release
          sha256sum "oracle-${DUCKDB_PLATFORM}.duckdb_extension" > "oracle-${DUCKDB_PLATFORM}.sha256"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: oracle-${{ matrix.platform }}-${{ matrix.arch }}
          path: deploy/*

  deploy-gh-pages:
    name: Deploy to GitHub Pages
    needs: [validate-version, build-matrix]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Prepare Deployment
        run: |
          mkdir -p deploy_content
          
          # Move v* directories (e.g., v1.1.3/linux_amd64/...) to deploy_content
          mv artifacts/v* deploy_content/
          
          # We don't need the flat copies for Pages, so we ignore them (they stay in artifacts/)

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./deploy_content
          keep_files: true # Important: Keep existing versions (e.g., v1.1.2) on the branch
          destination_dir: ./
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: "Deploy extension version ${{ needs.validate-version.outputs.version }}"

  create-release:
    name: Create Release
    needs: [validate-version, build-matrix]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Validate Artifacts
        id: validate
        run: |
          echo "=== Artifact Structure ==="
          find artifacts -type f -name "*.duckdb_extension" -o -name "*.sha256" | sort
          echo ""

          # Count platform-specific extension files
          # NOTE: Update this count if adding new platforms to the build matrix
          EXPECTED_COUNT=4  # linux_amd64, linux_arm64, osx_arm64, windows_amd64
          ACTUAL_COUNT=$(find artifacts/release -name "*.duckdb_extension" 2>/dev/null | wc -l)

          echo "Expected artifacts: $EXPECTED_COUNT"
          echo "Found artifacts: $ACTUAL_COUNT"

          if [ "$ACTUAL_COUNT" -lt "$EXPECTED_COUNT" ]; then
            echo "::warning::Expected $EXPECTED_COUNT platform artifacts, found $ACTUAL_COUNT"
            echo "Contents of artifacts directory:"
            ls -laR artifacts/
          fi

          # Merge all SHA256 checksums into single file
          echo "=== Generating Combined Checksums ==="
          cat artifacts/release/*.sha256 > artifacts/release/SHA256SUMS.txt
          cat artifacts/release/SHA256SUMS.txt

      - name: Generate Release Notes
        id: release_notes
        run: |
          VERSION=${{ needs.validate-version.outputs.version }}
          DUCKDB_VERSION=${{ needs.validate-version.outputs.duckdb_version }}

          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "## DuckDB Oracle Extension $VERSION" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "Built for DuckDB $DUCKDB_VERSION" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "## Platform Downloads" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "| Platform | Architecture | File |" >> $GITHUB_OUTPUT
          echo "|----------|--------------|------|" >> $GITHUB_OUTPUT
          echo "| Linux | x86_64 (AMD64) | \`oracle-linux_amd64.duckdb_extension\` |" >> $GITHUB_OUTPUT
          echo "| Linux | ARM64 | \`oracle-linux_arm64.duckdb_extension\` |" >> $GITHUB_OUTPUT
          echo "| macOS | ARM64 (Apple Silicon) | \`oracle-osx_arm64.duckdb_extension\` |" >> $GITHUB_OUTPUT
          echo "| Windows | x86_64 (AMD64) | \`oracle-windows_amd64.duckdb_extension\` |" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "## Verify Download" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "\`\`\`bash" >> $GITHUB_OUTPUT
          echo "# Download SHA256SUMS.txt and verify" >> $GITHUB_OUTPUT
          echo "sha256sum -c SHA256SUMS.txt" >> $GITHUB_OUTPUT
          echo "\`\`\`" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "## Installation" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "\`\`\`sql" >> $GITHUB_OUTPUT
          echo "-- Install from custom repository" >> $GITHUB_OUTPUT
          echo "SET custom_extension_repository = 'https://cofin.github.io/duckdb-oracle';" >> $GITHUB_OUTPUT
          echo "INSTALL oracle;" >> $GITHUB_OUTPUT
          echo "LOAD oracle;" >> $GITHUB_OUTPUT
          echo "\`\`\`" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "## Changes" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT

          if [ -z "$PREV_TAG" ]; then
            git log --pretty=format:"- %h %s" >> $GITHUB_OUTPUT
          else
            git log --pretty=format:"- %h %s" ${PREV_TAG}..HEAD >> $GITHUB_OUTPUT
          fi

          echo "" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.validate-version.outputs.version }}
          name: Release ${{ needs.validate-version.outputs.version }}
          body: ${{ steps.release_notes.outputs.notes }}
          draft: false
          prerelease: ${{ needs.validate-version.outputs.is_prerelease }}
          files: |
            artifacts/release/*.duckdb_extension
            artifacts/release/SHA256SUMS.txt
