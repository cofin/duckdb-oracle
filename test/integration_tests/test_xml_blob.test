# name: test/integration_tests/test_xml_blob.test
# description: Test XMLType and BLOB/RAW data
# group: [integration_tests]

require oracle

statement ok
CREATE SECRET (
    TYPE ORACLE,
    USER 'duckdb_test',
    PASSWORD 'duckdb_test',
    HOST 'localhost',
    PORT ${ORACLE_PORT},
    SERVICE 'FREEPDB1'
);

statement ok
ATTACH '' AS ora (TYPE ORACLE, SECRET 'test_oracle');

# --- XMLType ---

statement ok
SELECT oracle_execute('ora', '
    BEGIN
        EXECUTE IMMEDIATE ''DROP TABLE xml_test'';
    EXCEPTION
        WHEN OTHERS THEN
            IF SQLCODE != -942 THEN
                RAISE;
            END IF;
    END;
');

statement ok
SELECT oracle_execute('ora', '
    CREATE TABLE xml_test (
        id NUMBER,
        doc XMLTYPE
    )
');

statement ok
SELECT oracle_execute('ora', "INSERT INTO xml_test VALUES (1, XMLTYPE('<root><item>A</item></root>'))");

# DuckDB maps XMLTYPE to VARCHAR (usually)
query IT
SELECT id, CAST(doc AS VARCHAR) FROM ora.xml_test
----
1	<root><item>A</item></root>

# --- BLOB and RAW ---

statement ok
SELECT oracle_execute('ora', '
    BEGIN
        EXECUTE IMMEDIATE ''DROP TABLE binary_test'';
    EXCEPTION
        WHEN OTHERS THEN
            IF SQLCODE != -942 THEN
                RAISE;
            END IF;
    END;
');

statement ok
SELECT oracle_execute('ora', '
    CREATE TABLE binary_test (
        id NUMBER,
        raw_col RAW(10),
        blob_col BLOB
    )
');

# Insert hex data
# RAW: 'DEADBEEF'
# BLOB: 'CAFEBABE'
statement ok
SELECT oracle_execute('ora', "INSERT INTO binary_test VALUES (1, 'DEADBEEF', HEXTORAW('CAFEBABE'))");

# Verify reading as BLOB
query I
SELECT cast(raw_col as BLOB) FROM ora.binary_test
----
\xDE\xAD\xBE\xEF

query I
SELECT cast(blob_col as BLOB) FROM ora.binary_test
----
\xCA\xFE\xBA\xBE

statement ok
DETACH ora;
